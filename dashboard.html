 import express from "express";
import session from "express-session";
import cors from "cors";
import TronWeb from "tronweb";
import fetch from "node-fetch";

const app = express();
app.use(cors());
app.use(express.json());
app.use(session({
  secret: "usdt-system",
  resave: false,
  saveUninitialized: true
}));

/* ===== 内置默认配置（无需修改） ===== */
const ADMIN_USER = "admin";
const ADMIN_PASS = "admin123";

/* TG 为内置兜底，不影响系统运行 */
const TG_TOKEN = "";
const TG_CHAT = "";

/* 使用公共节点 + 动态生成地址（可收币） */
const tronWeb = new TronWeb({
  fullHost: "https://api.trongrid.io"
});

const USDT = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";
let orders = [];

/* ===== 登录 ===== */
app.post("/api/login",(req,res)=>{
  const {user,pass}=req.body;
  if(user===ADMIN_USER && pass===ADMIN_PASS){
    req.session.ok=true;
    res.json({ok:true});
  }else{
    res.json({ok:false});
  }
});

app.get("/api/check",(req,res)=>{
  res.json({ok:!!req.session.ok});
});

/* ===== 创建订单 ===== */
app.get("/api/create", async (req,res)=>{
  const acc = await tronWeb.createAccount();
  const order = {
    id: "U"+Date.now(),
    address: acc.address.base58,
    pk: acc.privateKey,
    amount: 100,
    status: "pending",
    time: Date.now()
  };
  orders.push(order);
  res.json(order);
});

/* ===== 后台订单 ===== */
app.get("/api/orders",(req,res)=>{
  if(!req.session.ok) return res.status(403).end();
  res.json(orders);
});

/* ===== TG 通知（静默兜底） ===== */
async function tg(msg){
  if(!TG_TOKEN||!TG_CHAT) return;
  await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:TG_CHAT,text:msg})
  });
}

/* ===== 自动监听 ===== */
setInterval(async ()=>{
  for(const o of orders){
    if(o.status!=="pending") continue;
    const c = await tronWeb.contract().at(USDT);
    const bal = await c.balanceOf(o.address).call();
    if(bal/1e6 >= o.amount){
      o.status="paid";
      tg(`USDT 到账\n订单:${o.id}\n金额:${o.amount}`);
    }
  }
},15000);

/* ===== 静态后台 ===== */
app.use(express.static("."));

app.listen(3000,()=>{
  console.log("✅ 系统运行：http://localhost:3000");
});
